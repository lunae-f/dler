## GitHub Issues for lunae-f/dler

1. コードの分離
2. UX（ユーザーエクスペリエンス）の向上
3. ダウンロードファイルのアクセス制御
4. プレイリストの挙動
5. 詳細なエラーハンドリング
6. バックエンドの非同期処理化
7. 本番環境用のWSGIサーバーの使用




### Issue #7: コードの分離

**概要:** JavaScriptのロジックがHTMLファイル内に直接記述されている。
**改善案:** コードがこれ以上長くなる場合は、main.js のような外部ファイルに分離すると、保守性が高まる。




### Issue #6: UX（ユーザーエクスペリエンス）の向上

**概要:** 現状は「処理中」であることしか分からない。
**改善案:** バックエンドを非同期化した場合、進捗状況（例：「ダウンロード中 50%」「エンコード中...」）を表示するバーやメッセージを追加すると、ユーザー体験が大幅に向上する。yt-dlpは進捗を出力するフック機能を提供しているため、これを利用してリアルタイムに進捗を更新することも可能。




### Issue #5: ダウンロードファイルのアクセス制御

**概要:** 現状、/downloads/ パスを知っていれば、誰でもダウンロードされたファイルにアクセスできる。
**改善案:** セキュリティを強化したい場合、ダウンロードURLに有効期限付きの署名を付けたり、API側で認証を行い、NginxのX-Accel-Redirectヘッダーを使って認証済みユーザーにのみファイルアクセスを許可する、といった高度な手法が考えられる。




### Issue #4: プレイリストの挙動

**概要:** プレイリストのURLが指定された場合、最初の動画の情報だけを利用している。
**改善案:** この挙動をUI上でユーザーに明示するか、プレイリスト内の動画を一覧表示して選択させる、あるいはZIPファイルにまとめてダウンロードするなどの機能拡張が考えられる。




### Issue #3: 詳細なエラーハンドリング

**概要:** 現状では、あらゆる例外を Exception として捕捉し、エラーメッセージをそのまま返している。これでは、ユーザーが原因を特定するのが困難（例：「この動画は非公開です」「年齢制限があります」など）。
**改善案:** yt_dlp.utils.DownloadError のような、yt-dlp が発生させる可能性のある特定の例外を個別に捕捉し、より分かりやすいエラーメッセージを生成してフロントエンドに返すように修正する。




### Issue #2: バックエンドの非同期処理化

**現状の問題点:** Flaskアプリケーションは、リクエストを受け取ると yt-dlp によるダウンロード処理を完了するまで応答を返さない（同期的処理）。動画のダウンロードには数秒から数分かかることがあり、その間、処理を実行しているワーカースレッドは他のリクエストを一切受け付けられなくなる。これにより、以下の問題が発生する可能性がある。
*   タイムアウト: 長時間処理により、Nginxやブラウザ側でタイムアウトが発生する可能性がある。
*   スケーラビリティの欠如: 同時に複数のダウンロードリクエストを効率的に捌くことができない。
*   UXの低下: ユーザーは処理が完了するまで、画面の前で待ち続けることになる。

**改善案:** ダウンロードのような時間のかかる処理は、バックグラウンドのタスクとして実行する非同期アーキテクチャに変更することを強く推奨する。
1.  タスクキューの導入: Celery や Redis Queue (RQ) といったタスクキューを導入する。
2.  処理フローの変更:
    *   フロントエンドからリクエストを受け取ったAPIは、ダウンロード処理を直接実行せず、タスクキューにジョブとして登録し、即座に「ジョブID」をレスポンスとして返す。
    *   バックグラウンドで独立した「ワーカー」プロセスがキューからジョブを取得し、実際のダウンロード処理を実行する。
    *   フロントエンドは、受け取ったジョブIDを使って、処理状況（待機中、処理中、完了、エラーなど）を問い合わせるためのAPIエンドポイントを定期的に呼び出す（ポーリング）。
    *   処理が完了したら、結果（ダウンロードリンクなど）を取得できる。

この変更により、サーバーはリクエストを即座に解放でき、多数のユーザーからのリクエストを効率的に受け付けられるようになる。




### Issue #1: 本番環境用のWSGIサーバーの使用

**概要:** 現状、Flaskに組み込まれている開発用サーバー (app.run) でアプリケーションが実行されている。これは開発には便利だが、本番環境での使用は推奨されていない。
**改善案:** Gunicorn や uWSGI といった本番用のWSGIサーバーを導入し、compose.yaml の command で起動するように変更する。これにより、パフォーマンスと安定性が向上する。


